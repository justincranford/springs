<html>
<head>
  <meta charset="utf-8"/>
  <title>WebAuthn Demo</title>
  <link href="css/fonts.css" rel="stylesheet" />
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen"/>
  <link href="css/bootstrap-responsive.min.css" rel="stylesheet"/>
  <link href="css/bootstrap-yubico.css" rel="stylesheet"/>
  <style type="text/css">
	.row {
	  display: table-row;
	}
	.row > * {
	  display: table-cell;
	  padding: 0.2em;
	}
	
	input[type="text"] {
	  height: 2em;
	  margin: 0;
	}
  </style>
  <script src="lib/text-encoding-0.7.0/encoding.js"></script>
  <script src="lib/text-encoding-0.7.0/encoding-indexes.js"></script>
  <script src="lib/base64js/base64js-1.3.0.min.js"></script>
  <script src="js/base64url.js"></script>

  <script type="module">
import * as webauthnJson from "./lib/webauthn-json-0.6.1/dist/esm/webauthn-json.js";

function base64urlToUint8Array(base64url) {
    // base64url to base64
    base64url = base64url.replace(/-/g, '+').replace(/_/g, '/');
    const padding = '='.repeat((4 - (base64url.length % 4)) % 4);
    const base64 = base64url + padding;

    // base64 to binary
    const binaryString = atob(base64);

    // binary to byte array
    const bytes = [];
    for (let i = 0; i < binaryString.length; i++) {
        bytes.push(binaryString.charCodeAt(i));
    }

    // byte array to Uint8Array
    return new Uint8Array(bytes);
}
function uint8ArrayToBase64url(uint8Array) {
    // Uint8Array to a binary string
    let binaryString = '';
    for (let i = 0; i < uint8Array.length; i++) {
        binaryString += String.fromCharCode(uint8Array[i]);
    }

    // Encode the binary string as Base64
    const base64String = btoa(binaryString);

    // Convert Base64 to Base64URL format
    return base64String
        .replace(/\+/g, '-')  // Replace + with -
        .replace(/\//g, '_')  // Replace / with _
        .replace(/=+$/, '');  // Remove padding '='
}

function getRegistrationClientStart() {
    const username                = document.getElementById('username').value;
    const displayName             = document.getElementById('displayName').value;
    const credentialNickname      = document.getElementById('credentialNickname').value;
    const registrationClientStart = { username, displayName, credentialNickname };
    console.log('registrationClientStartJson:', JSON.stringify(registrationClientStart));
    return registrationClientStart;
}

async function getRegistrationServerStart(registrationClientStart) {
    const httpResponse = await fetch('/api/v1/register/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json; charset=UTF-8',
            'Accept':       'application/json; charset=UTF-8'
        },
        body: JSON.stringify(registrationClientStart)
    });
    if (!httpResponse.ok) throw new Error(`Registration request failed: ${httpResponse.statusText}`);
    const registrationServerStart = await httpResponse.json();
    console.log('registrationServerStart:', JSON.stringify(registrationServerStart));
    return await registrationServerStart;
}

function toPublicKeyCredentialCreationOptions(publicKeyCredentialCreationOptions) {
    publicKeyCredentialCreationOptions.user.id   = base64urlToUint8Array(publicKeyCredentialCreationOptions.user.id);
    publicKeyCredentialCreationOptions.challenge = base64urlToUint8Array(publicKeyCredentialCreationOptions.challenge);
    const creationOptions  = { publicKey: publicKeyCredentialCreationOptions };
    console.log('creationOptions:', JSON.stringify(creationOptions));
    return creationOptions;
}

async function navigatorCredentialsCreate(publicKeyCredentialCreationOptions) {
    const publicKeyCredential = await navigator.credentials.create(publicKeyCredentialCreationOptions);
    if (!publicKeyCredential) throw new Error('Failed to create credential.');
    console.log('publicKeyCredential:', JSON.stringify(publicKeyCredential));
    return publicKeyCredential;
}

function fromPublicKeyCredential(sessionToken, publicKeyCredential) {
    const registrationClientFinish  = {
        sessionToken: sessionToken,
        publicKeyCredential: {
            id: publicKeyCredential.id,
            rawId: uint8ArrayToBase64url(new Uint8Array(publicKeyCredential.rawId)),
            response: {
                attestationObject: uint8ArrayToBase64url(new Uint8Array(publicKeyCredential.response.attestationObject)),
                clientDataJSON: uint8ArrayToBase64url(new Uint8Array(publicKeyCredential.response.clientDataJSON))
            },
            clientExtensionResults: publicKeyCredential.getClientExtensionResults(),
            type: publicKeyCredential.type
        }
    };
    console.log('registrationClientFinish:', JSON.stringify(registrationClientFinish));
    return registrationClientFinish;
}

async function getRegistrationServerFinish(registrationClientFinish) {
    const httpResponse = await fetch('/api/v1/register/finish', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json; charset=UTF-8',
            'Accept':       'application/json; charset=UTF-8'
        },
        body: JSON.stringify(registrationClientFinish)
    });

    if (!httpResponse.ok) throw new Error(`Request failed: ${httpResponse.statusText}`);
    const registrationServerFinish = await httpResponse.json();
    console.log('registrationServerFinish:', JSON.stringify(registrationServerFinish));
    return registrationServerFinish;
}

async function register() {
    try {
        const registrationClientStart            = getRegistrationClientStart();
        const registrationServerStart            = await getRegistrationServerStart(registrationClientStart);
        const publicKeyCredentialCreationOptions = toPublicKeyCredentialCreationOptions(registrationServerStart.publicKeyCredentialCreationOptions);
        const publicKeyCredential                = await navigatorCredentialsCreate(publicKeyCredentialCreationOptions);
        const registrationClientFinish           = fromPublicKeyCredential(registrationServerStart.sessionToken, publicKeyCredential);
        const registrationServerFinish           = await getRegistrationServerFinish(registrationClientFinish);
    } catch (error) {
        console.error('Registration Error:', error);
    }
}

function init() {
  document.getElementById("registerButton").onclick = register;
  return false;
}
window.onload = init;
</script>

</head>
	<body>
		<div class="base">
			<div class="content">
				<h1>WebAuthn Demo</h1>
				<form class="horizontal">
					<div class="row">
						<label for="username">Username:</label>
						<div><input type="text" id="username" value="My Username" /></div>
					</div>
					<div class="row">
						<label for="displayName">Display name:</label>
						<div><input type="text" id="displayName" value="My Display Name" /></div>
					</div>
	
					<div class="row">
						<label for="credentialNickname">Credential nickname:</label>
						<div><input type="text" id="credentialNickname"value="My Credential Nickname" /></div>
					</div>
	
					<div class="row">
						<label for="register">Register:</label>
						<button type="button" id="registerButton">Register</button>
					</div>
				</form>
			</div>
		</div>
	</body>
</html>
